<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTER EXPO S.A.S | Executive Dashboard 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-red: #B71C1C;
            --accent-red: #D32F2F;
            --dark: #121212;
            --bg: #F0F2F5;
            --gold: #D4AF37;
            --green: #1D6F42;
            --blue: #1976D2;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        .sidebar { 
            width: 400px; background: var(--dark); color: white; padding: 25px; 
            overflow-y: auto; display: flex; flex-direction: column; border-right: 5px solid var(--primary-red);
        }
        
        .month-selector {
            width: 100%; padding: 15px; background: var(--accent-red); color: white; border: none;
            border-radius: 8px; margin-bottom: 20px; font-weight: 700; cursor: pointer; font-size: 1rem;
            transition: all 0.3s;
        }
        .month-selector:hover { background: var(--primary-red); transform: translateY(-2px); }

        .project-card { 
            background: #1E1E1E; padding: 15px; border-radius: 8px; margin-bottom: 15px; 
            border-left: 4px solid #444; transition: all 0.3s;
        }
        .project-card:hover { border-left-color: var(--accent-red); }
        
        .input-group label { display: block; font-size: 0.6rem; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
        .input-group input { 
            width: 100%; background: #2A2A2A; border: 1px solid #333; color: white; 
            padding: 8px; border-radius: 4px; box-sizing: border-box; transition: all 0.3s;
        }
        .input-group input:focus { outline: none; border-color: var(--accent-red); }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { 
            padding: 12px 24px; background: white; border: none; border-radius: 8px 8px 0 0; 
            cursor: pointer; font-weight: 600; color: #666; transition: all 0.3s;
        }
        .tab-btn.active { background: var(--accent-red); color: white; }
        
        .section-title { 
            background: var(--dark); color: white; padding: 12px 20px; border-radius: 8px; 
            margin: 40px 0 20px 0; font-size: 0.9rem; letter-spacing: 2px; border-left: 8px solid var(--primary-red);
            display: flex; justify-content: space-between; align-items: center;
        }

        .nav-header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: linear-gradient(135deg, var(--dark) 0%, #2a2a2a 100%); 
            padding: 25px; border-radius: 12px; margin-bottom: 25px; color: white;
            box-shadow: 0 8px 24px rgba(183, 28, 28, 0.3);
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eee;
            position: relative; overflow: hidden; transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .stat-card::before { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; 
            background: linear-gradient(90deg, var(--accent-red), var(--gold));
        }
        .stat-card span { font-size: 0.65rem; color: #777; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card h3 { margin: 10px 0 0 0; color: var(--dark); font-size: 1.4rem; }
        .stat-card .trend { font-size: 0.75rem; margin-top: 8px; font-weight: 600; }
        .trend.up { color: var(--green); }
        .trend.down { color: var(--accent-red); }

        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-box { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: all 0.3s;
        }
        .chart-box:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .chart-box h4 { margin: 0 0 20px 0; color: var(--dark); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        .project-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8rem; }
        .project-table th { 
            text-align: left; padding: 12px 10px; border-bottom: 2px solid var(--accent-red); 
            color: var(--dark); font-weight: 700; text-transform: uppercase; font-size: 0.7rem;
        }
        .project-table td { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; }
        .project-table tr:hover { background: #fafafa; }

        .insight-box { 
            display: flex; align-items: center; gap: 15px; background: #fcfcfc; 
            padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--blue);
            transition: all 0.3s;
        }
        .insight-box:hover { background: #f5f5f5; }
        .insight-text b { display: block; font-size: 0.75rem; color: var(--dark); margin-bottom: 4px; }
        .insight-text small { color: #666; font-size: 0.65rem; }

        .alert-badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.65rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        .alert-success { background: #E8F5E9; color: var(--green); }
        .alert-warning { background: #FFF3E0; color: #F57C00; }
        .alert-danger { background: #FFEBEE; color: var(--accent-red); }

        .kpi-gauge { 
            width: 100%; height: 150px; position: relative; 
            background: linear-gradient(to right, var(--accent-red) 0%, #FFB74D 50%, var(--green) 100%);
            border-radius: 75px 75px 0 0; overflow: hidden;
        }
        .gauge-needle { 
            position: absolute; bottom: 0; left: 50%; width: 4px; height: 75px; 
            background: var(--dark); transform-origin: bottom center; transition: transform 0.5s;
        }

        .btn-action { 
            background: var(--accent-red); color: white; padding: 12px; border: none; 
            border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px;
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-action:hover { background: var(--primary-red); transform: translateY(-2px); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .comparison-bar {
            height: 30px; background: #eee; border-radius: 15px; overflow: hidden;
            position: relative; margin: 10px 0;
        }
        .comparison-fill {
            height: 100%; background: linear-gradient(90deg, var(--accent-red), var(--gold));
            display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;
            color: white; font-size: 0.7rem; font-weight: 700; transition: width 0.5s;
        }

        .metric-mini { 
            display: inline-block; background: #f5f5f5; padding: 8px 12px; 
            border-radius: 6px; margin: 5px; font-size: 0.7rem;
        }
        .metric-mini strong { color: var(--accent-red); }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color:var(--accent-red); font-size:0.9rem; margin: 0 0 5px 0; letter-spacing: 2px">PANEL DE CONTROL</h2>
    <p style="font-size: 0.6rem; color: #888; margin: 0 0 20px 0">Business Intelligence & Analytics</p>
    
    <select class="month-selector" id="selMonth" onchange="renderView()"></select>
    
    <div id="projectContainer"></div>
    
    <button class="btn-action" onclick="syncGlobal()">üîÑ Actualizar Dashboard</button>
    <button onclick="addNewProject()" style="background:none; border: 2px dashed #555; color:#888; width:100%; padding:10px; margin-top:10px; cursor:pointer; border-radius:8px; font-weight:600">+ A√±adir Proyecto</button>
    
    <div class="section-title" style="margin-top: 30px; font-size: 0.7rem">EXPORTAR REPORTES</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button onclick="exportToExcel()" style="background:#1D6F42; color:white; border:none; padding:12px; border-radius:8px; font-size:0.7rem; cursor:pointer; font-weight:700; transition:all 0.3s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üìä Excel</button>
        <button onclick="exportToPDF()" style="background:#333; color:white; border:none; padding:12px; border-radius:8px; font-size:0.7rem; cursor:pointer; font-weight:700; transition:all 0.3s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üìÑ PDF</button>
    </div>
</div>

<div class="main-content">
    <div class="nav-header">
        <div>
            <h1 style="margin:0; font-size: 1.5rem; font-weight: 900;">INTER EXPO S.A.S</h1>
            <p style="margin:5px 0 0 0; font-size: 0.75rem; opacity: 0.8;">Dashboard Ejecutivo - <span id="displayMonth"></span> 2026</p>
        </div>
        <div style="text-align: right">
            <span style="font-size: 0.65rem; font-weight: 700; opacity: 0.8; letter-spacing: 1px">UTILIDAD ACUMULADA 2026</span>
            <h2 id="totalAnualUtil" style="margin:5px 0 0 0; color: var(--gold); font-size: 2rem; font-weight: 900;">$ 0</h2>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab(0)">üìä Operacional</button>
        <button class="tab-btn" onclick="switchTab(1)">üìà An√°lisis Financiero</button>
        <button class="tab-btn" onclick="switchTab(2)">üéØ KPIs Ejecutivos</button>
    </div>

    <div class="tab-content active" id="tab0">
        <div class="stats-grid">
            <div class="stat-card">
                <span>üí∞ Ingresos Mes</span>
                <h3 id="m-ingreso">$ 0</h3>
                <div class="trend up" id="trend-ing">+0% vs mes anterior</div>
            </div>
            <div class="stat-card">
                <span>üí∏ Egresos Mes</span>
                <h3 id="m-costo">$ 0</h3>
                <div class="trend down" id="trend-cost">+0% vs mes anterior</div>
            </div>
            <div class="stat-card">
                <span>‚úÖ Utilidad Mes</span>
                <h3 id="m-utilidad">$ 0</h3>
                <div class="trend" id="trend-util">Meta: 40%</div>
            </div>
            <div class="stat-card">
                <span>üìä Margen Operativo</span>
                <h3 id="m-margen">0%</h3>
                <div class="trend" id="trend-margen">Benchmark: 35%</div>
            </div>
            <div class="stat-card">
                <span>üéØ Proyectos Activos</span>
                <h3 id="m-proyectos">0</h3>
                <div class="trend" id="trend-proy">Este mes</div>
            </div>
            <div class="stat-card">
                <span>‚ö° Eficiencia Operativa</span>
                <h3 id="m-eficiencia">0%</h3>
                <div class="trend" id="trend-efi">Ingreso/Costos</div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <h4>üìä An√°lisis Mensual de Proyectos</h4>
                <canvas id="monthBarChart" style="max-height: 250px"></canvas>
                <table class="project-table">
                    <thead><tr><th>Proyecto</th><th>Ingreso</th><th>Costos</th><th>Utilidad</th><th>Margen</th></tr></thead>
                    <tbody id="monthTableBody"></tbody>
                </table>
            </div>
            <div class="chart-box">
                <h4>üéØ Distribuci√≥n de Costos</h4>
                <canvas id="monthPieChart" style="max-height: 300px"></canvas>
                <div style="margin-top: 15px;">
                    <div class="metric-mini">Materiales: <strong id="pct-mat">0%</strong></div>
                    <div class="metric-mini">Mano de Obra: <strong id="pct-man">0%</strong></div>
                    <div class="metric-mini">Log√≠stica: <strong id="pct-log">0%</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab1">
        <div class="section-title">
            <span>üìà AN√ÅLISIS FINANCIERO ANUAL</span>
            <span id="healthIndicator" class="alert-badge alert-success">SALUD FINANCIERA: EXCELENTE</span>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <h4>üíπ Tendencia de Ingresos vs Costos (Mensual)</h4>
                <canvas id="trendLineChart" style="max-height: 300px"></canvas>
            </div>
            <div class="chart-box">
                <h4>üí∞ Composici√≥n Anual: Utilidad vs Costos</h4>
                <canvas id="compositionChart" style="max-height: 300px"></canvas>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <h4>üìä Comparativo Mensual de Utilidades</h4>
                <canvas id="utilityBarChart" style="max-height: 300px"></canvas>
            </div>
            <div class="chart-box">
                <h4>üîÑ Flujo de Caja Acumulado</h4>
                <canvas id="cashFlowChart" style="max-height: 300px"></canvas>
                <p style="font-size: 0.65rem; color: #888; margin-top: 15px;">
                    Visualiza el flujo de efectivo acumulado mes a mes para identificar per√≠odos cr√≠ticos.
                </p>
            </div>
        </div>

        <div class="chart-box">
            <h4>üéØ Comparaci√≥n Mensual: Desempe√±o Relativo</h4>
            <div id="monthlyComparison"></div>
        </div>
    </div>

    <div class="tab-content" id="tab2">
        <div class="section-title">üéØ INDICADORES CLAVE DE DESEMPE√ëO (KPIs)</div>

        <div class="charts-row">
            <div class="chart-box">
                <h4>üéØ ROI Anual (Return on Investment)</h4>
                <div style="text-align: center; padding: 20px">
                    <h2 id="y-roi" style="font-size: 3rem; color: var(--gold); margin: 0;">0%</h2>
                    <p style="color: #888; font-size: 0.7rem; margin: 10px 0">Retorno sobre inversi√≥n total del a√±o</p>
                    <div class="comparison-bar">
                        <div class="comparison-fill" id="roi-bar" style="width: 0%">0%</div>
                    </div>
                    <p style="font-size: 0.65rem; color: #666">Meta anual: 80% | Benchmark industria: 60%</p>
                </div>
            </div>

            <div class="chart-box">
                <h4>üíº Punto de Equilibrio</h4>
                <div style="text-align: center; padding: 20px">
                    <h2 id="y-bep-status" style="font-size: 3rem; color: var(--green); margin: 0;">0%</h2>
                    <p style="color: #888; font-size: 0.7rem; margin: 10px 0">Progreso hacia objetivo anual</p>
                    <div class="comparison-bar">
                        <div class="comparison-fill" id="bep-bar" style="width: 0%; background: linear-gradient(90deg, var(--green), #4CAF50)">0%</div>
                    </div>
                    <p style="font-size: 0.65rem; color: #666">Objetivo: $1,500M | Actual: <span id="actual-util">$0</span></p>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-box">
                <h4>üöÄ Proyecci√≥n de Cierre 2026</h4>
                <div style="text-align: center; padding: 20px">
                    <h2 id="y-proyeccion" style="font-size: 2.5rem; color: var(--blue); margin: 0;">$ 0</h2>
                    <p style="color: #888; font-size: 0.7rem; margin: 10px 0 20px 0">Basado en promedio mensual actual</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px">
                            <small style="font-size: 0.65rem; color: #888">ESCENARIO CONSERVADOR</small>
                            <h3 id="proj-low" style="margin: 5px 0; color: var(--accent-red)">$0</h3>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px">
                            <small style="font-size: 0.65rem; color: #888">ESCENARIO OPTIMISTA</small>
                            <h3 id="proj-high" style="margin: 5px 0; color: var(--green)">$0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-box">
                <h4>üìã Insights Estrat√©gicos</h4>
                <div id="insightsList"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee">
                    <h5 style="margin: 0 0 10px 0; font-size: 0.75rem; color: var(--dark)">üéØ RECOMENDACIONES</h5>
                    <div id="recommendations"></div>
                </div>
            </div>
        </div>

        <div class="chart-box">
            <h4>üìä Matriz de Proyectos: Rentabilidad vs Volumen</h4>
            <canvas id="scatterChart" style="max-height: 400px"></canvas>
            <p style="font-size: 0.65rem; color: #888; margin-top: 15px;">
                Identifica proyectos de alto valor (superior derecha) vs bajo rendimiento (inferior izquierda)
            </p>
        </div>
    </div>
</div>

<script>
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    let dataStore = JSON.parse(localStorage.getItem('interExpoData')) || {
        0: [{ name: "Stand Bavaria", ing: 150000000, mat: 40000000, man: 35000000, log: 20000000 }],
        1: [{ name: "Expoconstrucci√≥n", ing: 420000000, mat: 120000000, man: 80000000, log: 40000000 }],
        2: [{ name: "Feria Textil", ing: 280000000, mat: 75000000, man: 60000000, log: 30000000 }]
    };

    let charts = {};
    const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });

    function switchTab(index) {
        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i === index);
        });
        document.querySelectorAll('.tab-content').forEach((content, i) => {
            content.classList.toggle('active', i === index);
        });
    }

    function init() {
        const sel = document.getElementById('selMonth');
        meses.forEach((m, i) => sel.innerHTML += `<option value="${i}">${m}</option>`);
        initCharts();
        renderView();
        syncGlobal();
    }

    function initCharts() {
        const commonOptions = { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } };
        
        charts.monthBar = new Chart(document.getElementById('monthBarChart'), { 
            type: 'bar', 
            data: { labels: [], datasets: [
                { label: 'Ingreso', backgroundColor: '#B71C1C', data: [] },
                { label: 'Costos', backgroundColor: '#FF5252', data: [] }
            ]}, 
            options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
        });
        
        charts.monthPie = new Chart(document.getElementById('monthPieChart'), { 
            type: 'doughnut', 
            data: { labels: ['Materiales', 'Mano de Obra', 'Log√≠stica'], datasets: [{ 
                backgroundColor: ['#B71C1C', '#D32F2F', '#E57373'], data: [] 
            }]},
            options: commonOptions
        });
        
        charts.trendLine = new Chart(document.getElementById('trendLineChart'), {
            type: 'line',
            data: {
                labels: meses,
                datasets: [
                    { label: 'Ingresos', data: [], borderColor: '#1D6F42', backgroundColor: 'rgba(29, 111, 66, 0.1)', fill: true, tension: 0.4 },
                    { label: 'Costos', data: [], borderColor: '#B71C1C', backgroundColor: 'rgba(183, 28, 28, 0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
        });
        
        charts.composition = new Chart(document.getElementById('compositionChart'), {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [
                    { label: 'Utilidad', data: [], backgroundColor: '#D4AF37' },
                    { label: 'Costos', data: [], backgroundColor: '#B71C1C' }
                ]
            },
            options: { ...commonOptions, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
        });

        charts.utilityBar = new Chart(document.getElementById('utilityBarChart'), {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [{ label: 'Utilidad Mensual', data: [], backgroundColor: '#1976D2' }]
            },
            options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
        });

        charts.cashFlow = new Chart(document.getElementById('cashFlowChart'), {
            type: 'line',
            data: {
                labels: meses,
                datasets: [{ 
                    label: 'Flujo Acumulado', data: [], borderColor: '#1D6F42', 
                    backgroundColor: 'rgba(29, 111, 66, 0.2)', fill: true, tension: 0.4, borderWidth: 3
                }]
            },
            options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
        });

        charts.scatter = new Chart(document.getElementById('scatterChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Proyectos',
                    data: [],
                    backgroundColor: '#B71C1C'
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    x: { title: { display: true, text: 'Ingresos (M)' }, beginAtZero: true },
                    y: { title: { display: true, text: 'Margen (%)' }, beginAtZero: true }
                }
            }
        });
    }

    function renderView() {
        const mIdx = document.getElementById('selMonth').value;
        document.getElementById('displayMonth').innerText = meses[mIdx].toUpperCase();
        const container = document.getElementById('projectContainer');
        container.innerHTML = "";
        (dataStore[mIdx] || []).forEach((p, pIdx) => {
            container.innerHTML += `
                <div class="project-card">
                    <div class="input-group"><label>Proyecto</label><input type="text" value="${p.name}" onchange="updateData(${mIdx}, ${pIdx}, 'name', this.value)"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
                        <div class="input-group"><label>Ingreso ($)</label><input type="number" step="100000" value="${p.ing}" onchange="updateData(${mIdx}, ${pIdx}, 'ing', this.value)" placeholder="4500000"></div>
                        <div class="input-group"><label>Materiales ($)</label><input type="number" step="100000" value="${p.mat}" onchange="updateData(${mIdx}, ${pIdx}, 'mat', this.value)" placeholder="1200000"></div>
                        <div class="input-group"><label>Mano Obra ($)</label><input type="number" step="100000" value="${p.man}" onchange="updateData(${mIdx}, ${pIdx}, 'man', this.value)" placeholder="800000"></div>
                        <div class="input-group"><label>Log√≠stica ($)</label><input type="number" step="100000" value="${p.log}" onchange="updateData(${mIdx}, ${pIdx}, 'log', this.value)" placeholder="500000"></div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                        <small style="color: #888; font-size: 0.6rem">UTILIDAD: </small>
                        <strong style="color: var(--gold); font-size: 0.8rem">${fmt.format((p.ing - (p.mat + p.man + p.log)))}</strong>
                    </div>
                </div>`;
        });
    }

    function updateData(mIdx, pIdx, field, value) {
        dataStore[mIdx][pIdx][field] = (field === 'name') ? value : parseFloat(value) || 0;
        localStorage.setItem('interExpoData', JSON.stringify(dataStore));
        syncGlobal();
    }

    function addNewProject() {
        const mIdx = document.getElementById('selMonth').value;
        if(!dataStore[mIdx]) dataStore[mIdx] = [];
        dataStore[mIdx].push({ name: "Nuevo Evento", ing: 0, mat: 0, man: 0, log: 0 });
        renderView();
        syncGlobal();
    }

    function syncGlobal() {
        const mIdx = parseInt(document.getElementById('selMonth').value);
        const currentProjects = dataStore[mIdx] || [];
        
        let mIng = 0, mMat = 0, mMan = 0, mLog = 0;
        const tableBody = document.getElementById('monthTableBody');
        tableBody.innerHTML = "";
        
        currentProjects.forEach(p => {
            const cost = (p.mat + p.man + p.log);
            const util = p.ing - cost;
            const margen = p.ing > 0 ? ((util / p.ing) * 100) : 0;
            mIng += p.ing; mMat += p.mat; mMan += p.man; mLog += p.log;
            
            const statusClass = margen >= 35 ? 'alert-success' : margen >= 20 ? 'alert-warning' : 'alert-danger';
            tableBody.innerHTML += `<tr>
                <td><strong>${p.name}</strong></td>
                <td>${fmt.format(p.ing)}</td>
                <td>${fmt.format(cost)}</td>
                <td><strong style="color: var(--green)">${fmt.format(util)}</strong></td>
                <td><span class="alert-badge ${statusClass}">${margen.toFixed(1)}%</span></td>
            </tr>`;
        });

        const mCost = mMat + mMan + mLog;
        const mUtil = mIng - mCost;
        const mMargen = mIng > 0 ? ((mUtil / mIng) * 100) : 0;

        // Calcular tendencias vs mes anterior
        const prevMonth = mIdx > 0 ? mIdx - 1 : null;
        let trendIng = 0, trendCost = 0, trendUtil = 0;
        
        if (prevMonth !== null && dataStore[prevMonth]) {
            const prevProjects = dataStore[prevMonth];
            let prevIng = 0, prevCost = 0;
            prevProjects.forEach(p => {
                prevIng += p.ing;
                prevCost += (p.mat + p.man + p.log);
            });
            trendIng = prevIng > 0 ? (((mIng - prevIng) / prevIng) * 100) : 0;
            trendCost = prevCost > 0 ? (((mCost - prevCost) / prevCost) * 100) : 0;
            const prevUtil = prevIng - prevCost;
            trendUtil = prevUtil > 0 ? (((mUtil - prevUtil) / prevUtil) * 100) : 0;
        }

        document.getElementById('m-ingreso').innerText = fmt.format(mIng);
        document.getElementById('m-costo').innerText = fmt.format(mCost);
        document.getElementById('m-utilidad').innerText = fmt.format(mUtil);
        document.getElementById('m-margen').innerText = mMargen.toFixed(1) + "%";
        document.getElementById('m-proyectos').innerText = currentProjects.length;
        document.getElementById('m-eficiencia').innerText = mCost > 0 ? ((mIng / mCost) * 100).toFixed(0) + "%" : "N/A";

        // Actualizar tendencias
        document.getElementById('trend-ing').innerHTML = `${trendIng >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trendIng).toFixed(1)}% vs mes anterior`;
        document.getElementById('trend-ing').className = trendIng >= 0 ? 'trend up' : 'trend down';
        
        document.getElementById('trend-cost').innerHTML = `${trendCost >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trendCost).toFixed(1)}% vs mes anterior`;
        document.getElementById('trend-cost').className = trendCost >= 0 ? 'trend down' : 'trend up';
        
        document.getElementById('trend-util').innerHTML = `${trendUtil >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(trendUtil).toFixed(1)}% vs objetivo`;
        document.getElementById('trend-util').className = trendUtil >= 0 ? 'trend up' : 'trend down';
        
        document.getElementById('trend-margen').innerHTML = mMargen >= 35 ? '‚úÖ Sobre benchmark' : '‚ö†Ô∏è Bajo benchmark';
        document.getElementById('trend-margen').className = mMargen >= 35 ? 'trend up' : 'trend down';

        // Porcentajes de costos
        const totalCost = mMat + mMan + mLog;
        document.getElementById('pct-mat').innerText = totalCost > 0 ? ((mMat/totalCost)*100).toFixed(1) + "%" : "0%";
        document.getElementById('pct-man').innerText = totalCost > 0 ? ((mMan/totalCost)*100).toFixed(1) + "%" : "0%";
        document.getElementById('pct-log').innerText = totalCost > 0 ? ((mLog/totalCost)*100).toFixed(1) + "%" : "0%";

        // Datos anuales
        let yIng = 0, yCos = 0, mesesConDatos = 0, topProject = { name: "N/A", val: 0, margen: 0 };
        let maxMonth = { name: "N/A", val: 0 }, minMonth = { name: "N/A", val: Infinity };
        const dataUtils = [], dataCosts = [], dataIngresos = [], dataCostos = [], cashFlow = [];
        let accumulated = 0;
        const scatterData = [];

        meses.forEach((m, i) => {
            const projs = dataStore[i] || [];
            let mi = 0, mc = 0;
            if(projs.length > 0) mesesConDatos++;
            
            projs.forEach(p => { 
                mi += p.ing; 
                mc += (p.mat + p.man + p.log);
                const pMargen = p.ing > 0 ? ((p.ing - (p.mat + p.man + p.log)) / p.ing * 100) : 0;
                
                if(p.ing > topProject.val) {
                    topProject = { name: p.name, val: p.ing, margen: pMargen };
                }
                
                // Datos para scatter
                scatterData.push({
                    x: p.ing,
                    y: pMargen,
                    label: p.name
                });
            });
            
            if(mi > maxMonth.val) maxMonth = { name: m, val: mi };
            if(mi < minMonth.val && mi > 0) minMonth = { name: m, val: mi };
            
            yIng += mi; 
            yCos += mc;
            dataUtils.push(mi - mc);
            dataCosts.push(mc);
            dataIngresos.push(mi);
            dataCostos.push(mc);
            accumulated += (mi - mc);
            cashFlow.push(accumulated);
        });

        const yUtil = yIng - yCos;
        const promedio = mesesConDatos > 0 ? yUtil / mesesConDatos : 0;
        const yMargen = yIng > 0 ? ((yUtil / yIng) * 100) : 0;

        document.getElementById('totalAnualUtil').innerText = fmt.format(yUtil);
        document.getElementById('y-proyeccion').innerText = fmt.format(promedio * 12);
        document.getElementById('proj-low').innerText = fmt.format(promedio * 10);
        document.getElementById('proj-high').innerText = fmt.format(promedio * 14);
        
        const roi = yCos > 0 ? ((yUtil / yCos) * 100) : 0;
        document.getElementById('y-roi').innerText = roi.toFixed(1) + "%";
        document.getElementById('roi-bar').style.width = Math.min(roi, 100) + "%";
        document.getElementById('roi-bar').innerText = roi.toFixed(1) + "%";
        
        const bepProgress = (yUtil / 1500000000) * 100;
        document.getElementById('y-bep-status').innerText = bepProgress.toFixed(1) + "%";
        document.getElementById('bep-bar').style.width = Math.min(bepProgress, 100) + "%";
        document.getElementById('bep-bar').innerText = bepProgress.toFixed(1) + "%";
        document.getElementById('actual-util').innerText = fmt.format(yUtil);

        // Indicador de salud financiera
        const health = document.getElementById('healthIndicator');
        if (yMargen >= 35) {
            health.className = 'alert-badge alert-success';
            health.innerText = 'SALUD FINANCIERA: EXCELENTE';
        } else if (yMargen >= 25) {
            health.className = 'alert-badge alert-warning';
            health.innerText = 'SALUD FINANCIERA: BUENA';
        } else {
            health.className = 'alert-badge alert-danger';
            health.innerText = 'SALUD FINANCIERA: REQUIERE ATENCI√ìN';
        }

        // Insights
        const avgProjectSize = currentProjects.length > 0 ? mIng / currentProjects.length : 0;
        const efficiency = mCost > 0 ? (mIng / mCost) : 0;
        
        document.getElementById('insightsList').innerHTML = `
            <div class="insight-box" style="border-left-color: var(--gold)">
                <div style="font-size: 2rem">üèÜ</div>
                <div class="insight-text">
                    <b>Proyecto Estrella del A√±o</b>
                    <small>${topProject.name} - ${fmt.format(topProject.val)} (Margen: ${topProject.margen.toFixed(1)}%)</small>
                </div>
            </div>
            <div class="insight-box" style="border-left-color: var(--green)">
                <div style="font-size: 2rem">üìÖ</div>
                <div class="insight-text">
                    <b>Mejor Mes del A√±o</b>
                    <small>${maxMonth.name} con ${fmt.format(maxMonth.val)} en ingresos</small>
                </div>
            </div>
            <div class="insight-box" style="border-left-color: var(--accent-red)">
                <div style="font-size: 2rem">üìä</div>
                <div class="insight-text">
                    <b>Margen Operativo Anual</b>
                    <small>${yMargen.toFixed(1)}% del total facturado</small>
                </div>
            </div>
            <div class="insight-box" style="border-left-color: var(--blue)">
                <div style="font-size: 2rem">üí∞</div>
                <div class="insight-text">
                    <b>Tama√±o Promedio de Proyecto</b>
                    <small>${fmt.format(avgProjectSize)} por evento</small>
                </div>
            </div>
        `;

        // Recomendaciones
        let recommendations = '';
        if (mMargen < 25) {
            recommendations += `<div class="insight-box" style="border-left-color: var(--accent-red)"><div style="font-size: 1.5rem">‚ö†Ô∏è</div><div class="insight-text"><b>Optimizar costos operativos</b><small>El margen actual est√° por debajo del benchmark de la industria</small></div></div>`;
        }
        if (efficiency < 1.5) {
            recommendations += `<div class="insight-box" style="border-left-color: #F57C00"><div style="font-size: 1.5rem">üìà</div><div class="insight-text"><b>Mejorar eficiencia</b><small>Ratio ingresos/costos sugiere espacio para optimizaci√≥n</small></div></div>`;
        }
        if (mesesConDatos < 12 && promedio > 0) {
            recommendations += `<div class="insight-box" style="border-left-color: var(--green)"><div style="font-size: 1.5rem">üöÄ</div><div class="insight-text"><b>Acelerar cierre de proyectos</b><small>Hay potencial para superar las proyecciones</small></div></div>`;
        }
        if (recommendations === '') {
            recommendations = `<div class="insight-box" style="border-left-color: var(--green)"><div style="font-size: 1.5rem">‚úÖ</div><div class="insight-text"><b>Operaci√≥n √≥ptima</b><small>Todos los indicadores dentro de los rangos esperados</small></div></div>`;
        }
        document.getElementById('recommendations').innerHTML = recommendations;

        // Comparaci√≥n mensual
        let compHtml = '';
        meses.forEach((m, i) => {
            const projs = dataStore[i] || [];
            let mi = 0, mc = 0;
            projs.forEach(p => { mi += p.ing; mc += (p.mat + p.man + p.log); });
            const mu = mi - mc;
            const mm = mi > 0 ? ((mu / mi) * 100) : 0;
            const maxUtil = Math.max(...dataUtils);
            const pct = maxUtil > 0 ? (mu / maxUtil * 100) : 0;
            
            compHtml += `
                <div style="margin-bottom: 15px">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px">
                        <strong style="font-size: 0.75rem">${m}</strong>
                        <span style="font-size: 0.7rem; color: #888">${fmt.format(mu)} (${mm.toFixed(1)}%)</span>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-fill" style="width: ${pct}%">${pct > 10 ? pct.toFixed(0) + '%' : ''}</div>
                    </div>
                </div>
            `;
        });
        document.getElementById('monthlyComparison').innerHTML = compHtml;

        // Actualizar gr√°ficas
        charts.monthBar.data.labels = currentProjects.map(p => p.name);
        charts.monthBar.data.datasets[0].data = currentProjects.map(p => p.ing);
        charts.monthBar.data.datasets[1].data = currentProjects.map(p => p.mat + p.man + p.log);
        charts.monthBar.update();

        charts.monthPie.data.datasets[0].data = [mMat, mMan, mLog];
        charts.monthPie.update();

        charts.trendLine.data.datasets[0].data = dataIngresos;
        charts.trendLine.data.datasets[1].data = dataCostos;
        charts.trendLine.update();

        charts.composition.data.datasets[0].data = dataUtils;
        charts.composition.data.datasets[1].data = dataCosts;
        charts.composition.update();

        charts.utilityBar.data.datasets[0].data = dataUtils;
        charts.utilityBar.update();

        charts.cashFlow.data.datasets[0].data = cashFlow;
        charts.cashFlow.update();

        charts.scatter.data.datasets[0].data = scatterData;
        charts.scatter.update();
    }

    function exportToExcel() {
        let rows = [["Mes", "Proyecto", "Ingreso ($)", "Materiales ($)", "Mano Obra ($)", "Log√≠stica ($)", "Costo Total ($)", "Utilidad ($)", "Margen %"]];
        meses.forEach((m, i) => { 
            (dataStore[i] || []).forEach(p => { 
                const cost = p.mat + p.man + p.log;
                const util = p.ing - cost;
                const margen = p.ing > 0 ? ((util / p.ing) * 100) : 0;
                rows.push([m, p.name, p.ing, p.mat, p.man, p.log, cost, util, margen.toFixed(2)]); 
            }); 
        });
        
        // Agregar resumen anual
        rows.push([]);
        rows.push(["RESUMEN ANUAL"]);
        let totalIng = 0, totalCost = 0;
        Object.values(dataStore).forEach(projs => {
            projs.forEach(p => {
                totalIng += p.ing;
                totalCost += (p.mat + p.man + p.log);
            });
        });
        rows.push(["Total Ingresos", "", totalIng, "", "", "", "", "", ""]);
        rows.push(["Total Costos", "", "", "", "", "", totalCost, "", ""]);
        rows.push(["Utilidad Neta", "", "", "", "", "", "", totalIng - totalCost, ""]);
        rows.push(["Margen Global", "", "", "", "", "", "", "", totalIng > 0 ? (((totalIng - totalCost) / totalIng) * 100).toFixed(2) : 0]);
        
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte Completo");
        XLSX.writeFile(wb, "INTER_EXPO_Dashboard_2026.xlsx");
    }

    function exportToPDF() {
        const element = document.getElementById('reportArea');
        const opt = {
            margin: 10,
            filename: 'INTER_EXPO_Executive_Report_2026.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }

    window.onload = init;
</script>
</body>
</html>